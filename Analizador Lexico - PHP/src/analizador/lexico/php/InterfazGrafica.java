
package analizador.lexico.php;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JFileChooser;
import javax.swing.JOptionPane;
import javax.swing.filechooser.FileNameExtensionFilter;

/**
 *
 * @author bryan
 */
public class InterfazGrafica extends javax.swing.JFrame {
    
    private String ruta;
    private String nombre;

    public InterfazGrafica() {
        initComponents();
        ruta = "";
        nombre = "";
        
        //Componentes
        this.setLocationRelativeTo(null);
        btnAnalizar.setEnabled(false);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        btnCargarArchivo = new javax.swing.JButton();
        btnEscaner = new javax.swing.JButton();
        lblCargarArchivo = new javax.swing.JLabel();
        lblEscaner = new javax.swing.JLabel();
        btnAnalizar = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);

        btnCargarArchivo.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCargarArchivoActionPerformed(evt);
            }
        });

        btnEscaner.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnEscanerActionPerformed(evt);
            }
        });

        lblCargarArchivo.setText("Compilar Archivo Lexer");

        lblEscaner.setText("Cargar Archivo PHP");

        btnAnalizar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAnalizarActionPerformed(evt);
            }
        });

        jLabel1.setText("Analizar Archivo");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(38, 38, 38)
                        .addComponent(btnCargarArchivo, javax.swing.GroupLayout.PREFERRED_SIZE, 65, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(77, 77, 77)
                        .addComponent(btnEscaner, javax.swing.GroupLayout.PREFERRED_SIZE, 65, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(18, 18, 18)
                        .addComponent(lblCargarArchivo)
                        .addGap(42, 42, 42)
                        .addComponent(lblEscaner)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 57, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(btnAnalizar, javax.swing.GroupLayout.PREFERRED_SIZE, 65, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel1))
                .addGap(34, 34, 34))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(btnAnalizar, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addGap(0, 0, Short.MAX_VALUE)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(btnCargarArchivo, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 65, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(btnEscaner, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 65, javax.swing.GroupLayout.PREFERRED_SIZE))))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblCargarArchivo)
                    .addComponent(lblEscaner)
                    .addComponent(jLabel1))
                .addGap(14, 14, 14))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnCargarArchivoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCargarArchivoActionPerformed
        // TODO add your handling code here:
        
        JFileChooser chooser = new JFileChooser();
        chooser.setFileSelectionMode( JFileChooser.FILES_ONLY );
        FileNameExtensionFilter filter = new FileNameExtensionFilter("Archivos Lexicos", "flex");
        chooser.setFileFilter(filter);
        int seleccion  = chooser.showOpenDialog(this);
        
        if(seleccion == JFileChooser.APPROVE_OPTION){
            
            if(chooser.getSelectedFile() != null)
            {
                ruta = chooser.getSelectedFile().getAbsolutePath();

                File archivo = new File(ruta);

                if(archivo.exists()){
                    
                    try{
                        //Compilar el archivo .Flex
                        jflex.Main.main(new String[]{ruta});
                        
                        JOptionPane.showMessageDialog(null,
                        "El archivo (.flex) ha compilado correctamente.",
                        "Aviso",JOptionPane.INFORMATION_MESSAGE);
                    }
                    catch(Exception e)
                    {
                        JOptionPane.showMessageDialog(null,
                        "No se ha podido compilar el archivo (.flex).",
                        "ERROR",JOptionPane.ERROR_MESSAGE);
                    }                  
                }
                else{
                    JOptionPane.showMessageDialog(null,
                    "El archivo seleccionado no puede ser encontrado.",
                    "ERROR",JOptionPane.ERROR_MESSAGE);
                }
            } 
        }
        
               
    }//GEN-LAST:event_btnCargarArchivoActionPerformed

    private void btnEscanerActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnEscanerActionPerformed
        
        JFileChooser chooser = new JFileChooser();
        chooser.setFileSelectionMode( JFileChooser.FILES_ONLY );
        FileNameExtensionFilter filter = new FileNameExtensionFilter("Archivos PHP", "php", "txt");
        chooser.setFileFilter(filter);
        int seleccion  = chooser.showOpenDialog(this);
        
        if(seleccion == JFileChooser.APPROVE_OPTION){
            
            if(chooser.getSelectedFile() != null)
            {
                ruta = chooser.getSelectedFile().getAbsolutePath();
                nombre = chooser.getSelectedFile().getName();

                File archivo = new File(ruta);

                if(archivo.exists()){
                    
                    try{              
                        JOptionPane.showMessageDialog(null,
                        "El archivo se ha cargado correctamente.",
                        "Información",JOptionPane.INFORMATION_MESSAGE);
                        
                        btnAnalizar.setEnabled(true);
                    }
                    catch(Exception e)
                    {
                        JOptionPane.showMessageDialog(null,
                        "No se ha podido cargar el archivo. \nError: " + e.getMessage(),
                        "ERROR",JOptionPane.ERROR_MESSAGE);
                    }                  
                }
                else{
                    JOptionPane.showMessageDialog(null,
                    "El archivo seleccionado no puede ser encontrado.",
                    "ERROR",JOptionPane.ERROR_MESSAGE);
                }
            } 
        }           
    }//GEN-LAST:event_btnEscanerActionPerformed

    private void btnAnalizarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAnalizarActionPerformed
        
        ArrayList<String> errores = null;
        ArrayList<String> code = null;
        
        //Cargar el archivo de la ruta 
        BufferedReader reader = null;
        try {
            //Ruta del archivo especificado por el usuario
            reader = new BufferedReader(new FileReader(ruta));
            LexicalScannerPHP lexer = new LexicalScannerPHP(reader);
            
            Yytoken token = null;
            
            while(true){
                token = lexer.nextToken();
                
                if(token==null){
                    break;
                }else{
                    System.out.println(token.toString());
                }
            }
            
            errores = lexer.errores;
            code = lexer.tokens;
            reader.close();
        } catch (FileNotFoundException ex) {
            Logger.getLogger(InterfazGrafica.class.getName()).log(Level.SEVERE, null, ex);
        } catch (IOException ex) {
            Logger.getLogger(InterfazGrafica.class.getName()).log(Level.SEVERE, null, ex);
        }
        
        
        //Una vez finalizado el analisis verificamos si el archivo es correcto o  no
 
        String result = "";
        
        if(errores.size() > 0){
            //Hay errores
            
            JOptionPane.showMessageDialog(null,
                    "El archivo analizado contiene errores léxicos, el programa\n"
                    +"generará un archivo con los errores encontrados.\n\n"
                    +"Por favor eliga un nombre y una ruta en la cual desee\n"
                    +"almacenar dicho archivo",
                    "Aviso",JOptionPane.INFORMATION_MESSAGE);
            
            for(int i = 0; i < errores.size(); i++){
                
                if(i == errores.size() - 1){
                    result += errores.get(i);
                }else{
                    result += errores.get(i) + "\n";
                }          
            }
            
            //Crear el archivo de salida
            File file = new File("output.err");
            
            JFileChooser chooser = new JFileChooser();
            FileNameExtensionFilter filter = new FileNameExtensionFilter("Archivo de errores", "err");
            chooser.setFileFilter(filter);     
            chooser.setSelectedFile(file);
  
            int selection  = chooser.showSaveDialog(this);

            if(selection == JFileChooser.APPROVE_OPTION)
            {
                try {
                    
                    String name = chooser.getSelectedFile().getAbsolutePath();
                   
                    if(!name.contains(".err")){
                        name = name + ".err";
                    }
                                 
                    file = new File(name);
                    FileWriter writer = null;
                    BufferedWriter bw = null;
                    
                    if(file.exists()){
                        file.delete();
                        writer = new FileWriter(file);
                        bw = new BufferedWriter(writer);
                        bw.write(result);
                        bw.close();
                    }else{
                        writer = new FileWriter(file);
                        bw = new BufferedWriter(writer);
                        bw.write(result);
                        bw.close();                     
                    }
                    
                    JOptionPane.showMessageDialog(null,
                    "El archivo se ha guardado correctamente.",
                    "Información",JOptionPane.INFORMATION_MESSAGE);
                                       
                } catch (IOException ex) {
                    Logger.getLogger(InterfazGrafica.class.getName()).log(Level.SEVERE, null, ex);
                }
            }  
        }
        else{
            //NO hay errores
            
            JOptionPane.showMessageDialog(null,
                    "El archivo ingresado pertenece al lenguaje PHP.\n\n"
                    +"Por favor eliga un nombre y una ruta en la cual desee\n"
                    +"almacenar el archivo de salida.",
                    "Información",JOptionPane.INFORMATION_MESSAGE);
                
            for(int i = 0; i < code.size(); i++){
                result += code.get(i);
            }
            
            //Crear el archivo de salida
            File file = new File(nombre);
  
            JFileChooser chooser = new JFileChooser();
            FileNameExtensionFilter filter = new FileNameExtensionFilter("Archivo de salida", "out");
            chooser.setFileFilter(filter);     
            chooser.setSelectedFile(file);
  
            int selection  = chooser.showSaveDialog(this);

            if(selection == JFileChooser.APPROVE_OPTION)
            {
                try {
                    String name = chooser.getSelectedFile().getAbsolutePath();
                   
                    if(!name.contains(".out")){
                        name = name + ".out";
                    }
                    
                    file = new File(name);
                    
                    
                    FileWriter writer = null;
                    BufferedWriter bw = null;
                    
                    if(file.exists()){
                        file.delete();
                        writer = new FileWriter(file);
                        bw = new BufferedWriter(writer);
                        bw.write(result);
                        bw.close();
                    }else{
                        writer = new FileWriter(file);
                        bw = new BufferedWriter(writer);
                        bw.write(result);
                        bw.close();                     
                    }
                    
                    JOptionPane.showMessageDialog(null,
                    "El archivo se ha guardado correctamente.",
                    "Información",JOptionPane.INFORMATION_MESSAGE);
                                       
                } catch (IOException ex) {
                    Logger.getLogger(InterfazGrafica.class.getName()).log(Level.SEVERE, null, ex);
                }
            }      
        }   
    }//GEN-LAST:event_btnAnalizarActionPerformed

    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(InterfazGrafica.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(InterfazGrafica.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(InterfazGrafica.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(InterfazGrafica.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new InterfazGrafica().setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAnalizar;
    private javax.swing.JButton btnCargarArchivo;
    private javax.swing.JButton btnEscaner;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel lblCargarArchivo;
    private javax.swing.JLabel lblEscaner;
    // End of variables declaration//GEN-END:variables
}
